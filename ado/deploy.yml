parameters:
  - name: artifactName
  - name: backendAzureRmContainerName
  - name: backendAzureRmKey
  - name: backendAzureRmResourceGroupName
  - name: backendAzureRmStorageAccountName
  - name: environmentName
  - name: globalTerraformVariableFilename
  - name: pathToTerraformDirectory
  - name: pathToTerraformVariableDirectory
  - name: serviceConnectionName
  - name: webAppProjectName

steps:
  - checkout: self
    persistCredentials: true
  - template: printEnv.yml
  - template: deployTerraform.yml
    parameters:
      backendAzureRmContainerName: ${{ parameters.backendAzureRmContainerName }}
      backendAzureRmKey: ${{ parameters.backendAzureRmKey }}
      backendAzureRmResourceGroupName: ${{ parameters.backendAzureRmResourceGroupName }}
      backendAzureRmStorageAccountName: ${{ parameters.backendAzureRmStorageAccountName }}
      backendServiceArm: ${{ parameters.serviceConnectionName }}
      environmentName: ${{ parameters.environmentName }}
      globalTerraformVariableFilename: ${{ parameters.globalTerraformVariableFilename }}
      environmentServiceNameAzureRM: ${{ parameters.serviceConnectionName }}
      pathToTerraformDirectory: ${{ parameters.pathToTerraformDirectory }}
      pathToTerraformVariableDirectory: ${{ parameters.pathToTerraformVariableDirectory }}
  - template: deployWebApp.yml
    parameters:
      appServiceName: $(terraformOutput.appServiceName) 
      artifactName: $(Pipeline.Workspace)/${{ parameters.artifactName }}/${{ parameters.webAppProjectName }}.zip
      serviceConnectionName: ${{ parameters.serviceConnectionName }}