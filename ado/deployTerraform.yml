parameters:
  - name: environmentName
  - name: pathToTerraformDirectory
  - name: pathToTerraformVariableDirectory
  - name: environmentServiceNameAzureRM
  - name: backendServiceArm
  - name: backendAzureRmResourceGroupName
  - name: backendAzureRmStorageAccountName
  - name: backendAzureRmContainerName
  - name: backendAzureRmKey
  
steps:
  - task: TerraformInstaller@0
    displayName: Install Terraform
    inputs:
      terraformVersion: 1.0.0
  - task: TerraformTaskV2@2
    displayName: Terraform - Initialize
    inputs:
      command: init
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      backendServiceArm: ${{ parameters.backendServiceArm }}
      backendAzureRmResourceGroupName: ${{ parameters.backendAzureRmResourceGroupName }}
      backendAzureRmStorageAccountName: ${{ parameters.backendAzureRmStorageAccountName }}
      backendAzureRmContainerName: ${{ parameters.backendAzureRmContainerName }}
      backendAzureRmKey: ${{ parameters.backendAzureRmKey }}
  - task: TerraformTaskV2@2
    displayName: Terraform - Validate
    inputs:
      command: validate
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      backendServiceArm: ${{ parameters.backendServiceArm }}
      backendAzureRmResourceGroupName: ${{ parameters.backendAzureRmResourceGroupName }}
      backendAzureRmStorageAccountName: ${{ parameters.backendAzureRmStorageAccountName }}
      backendAzureRmContainerName: ${{ parameters.backendAzureRmContainerName }}
      backendAzureRmKey: ${{ parameters.backendAzureRmKey }}
  - task: TerraformTaskV2@2
    displayName: Terraform - Plan
    inputs:
      command: plan
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      commandOptions: |
        -var-file=${{ parameters.pathToTerraformDirectory }}/environments/dev.tfvars 
        -var SQLSERVERADMINUSERNAME=$(TF_VAR_SQLSERVERADMINUSERNAME)
        -var SQLSERVERADMINPASSWORD=$(TF_VAR_SQLSERVERADMINPASSWORD)
        -var WEBAPPCLIENTSECRET=$(TF_VAR_WEBAPPCLIENTSECRET)
      backendServiceArm: ${{ parameters.backendServiceArm }}
      backendAzureRmResourceGroupName: ${{ parameters.backendAzureRmResourceGroupName }}
      backendAzureRmStorageAccountName: ${{ parameters.backendAzureRmStorageAccountName }}
      backendAzureRmContainerName: ${{ parameters.backendAzureRmContainerName }}
      backendAzureRmKey: ${{ parameters.backendAzureRmKey }}
      environmentServiceNameAzureRM: ${{ parameters.environmentServiceNameAzureRM }}
  - task: TerraformTaskV2@2
    displayName: Terraform - Apply
    inputs:
      command: apply
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      commandOptions: '-var-file=${{ parameters.pathToTerraformDirectory }}/environments/dev.tfvars'
      backendServiceArm: ${{ parameters.backendServiceArm }}
      backendAzureRmResourceGroupName: ${{ parameters.backendAzureRmResourceGroupName }}
      backendAzureRmStorageAccountName: ${{ parameters.backendAzureRmStorageAccountName }}
      backendAzureRmContainerName: ${{ parameters.backendAzureRmContainerName }}
      backendAzureRmKey: ${{ parameters.backendAzureRmKey }}
      environmentServiceNameAzureRM: ${{ parameters.environmentServiceNameAzureRM }}