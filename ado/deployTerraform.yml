parameters:
  - name: environmentName
  - name: globalTerraformVariableFilename
  - name: pathToTerraformDirectory
  - name: pathToTerraformEnvironmentVariablesDirectory
  - name: serviceConnectionName
  
steps:
  - task: TerraformInstaller@0
    displayName: Install Terraform
    inputs:
      terraformVersion: 1.0.0
  - task: AzureCLI@2
    displayName: Terraform - Initialize
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        terraform init
  - task: AzureCLI@2
    displayName: Terraform - Switch Workspace
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        terraform workspace select ${{ parameters.environmentName }} 
  - task: AzureCLI@2
    displayName: Terraform - Validate 
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        terraform validate 
  - task: AzureCLI@2
    displayName: Terraform - Plan 
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        terraform plan \
        -var-file=${{ parameters.pathToTerraformEnvironmentVariablesDirectory }}/${{ parameters.globalTerraformVariableFilename }}.tfvars \
        -var-file=${{ parameters.pathToTerraformEnvironmentVariablesDirectory }}/${{ parameters.environmentName }}.tfvars \
        -var "SQLSERVERADMINUSERNAME=$(TF_VAR_SQLSERVERADMINUSERNAME)" \
        -var "SQLSERVERADMINPASSWORD=$(TF_VAR_SQLSERVERADMINPASSWORD)" \
        -var "WEBAPPCLIENTSECRET=$(TF_VAR_WEBAPPCLIENTSECRET)" \
        -input=false \
        -out tfplan
  - task: AzureCLI@2
    displayName: Terraform - Apply 
    inputs:
      azureSubscription: ${{ parameters.serviceConnectionName }}
      workingDirectory: ${{ parameters.pathToTerraformDirectory }}
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: 
        terraform apply \
        -var-file=${{ parameters.pathToTerraformEnvironmentVariablesDirectory }}/${{ parameters.globalTerraformVariableFilename }}.tfvars \
        -var-file=${{ parameters.pathToTerraformEnvironmentVariablesDirectory }}/${{ parameters.environmentName }}.tfvars \
        -var "SQLSERVERADMINUSERNAME=$(TF_VAR_SQLSERVERADMINUSERNAME)" \
        -var "SQLSERVERADMINPASSWORD=$(TF_VAR_SQLSERVERADMINPASSWORD)" \
        -var "WEBAPPCLIENTSECRET=$(TF_VAR_WEBAPPCLIENTSECRET)" \
        -input=false \
        tfplan
  - powershell: |
      $terraformOutput = Get-Content "$(terraformApply.jsonOutputVariablesPath)" | ConvertFrom-Json
      $terraformOutput | Get-Member -MemberType NoteProperty | % { $o = $terraformOutput.($_.Name); Write-Host "##vso[task.setvariable variable=$($_.Name);isoutput=true;issecret=$($o.sensitive)]$($o.value)" }
    name: terraformOutput
    displayName: Read Terraform outputs